---
title: "Arctic LTER % Cover Data Exploration"
output: html_notebook
editor_options: 
  chunk_output_type: console
---
```{r}
library(tidyverse)
library(lubridate)
```

Add analyses to this when they output figures that I want to save. 

## MAT06 read-in 2021 data
```{r}
# Description: R Script to read in % cover sheets and % cover totals from Arctic LTER MAT06 plots 2021 
# Author: Ruby An
# Date: 2022-02-14


## required packages
library(tidyverse)

## functions 
read_cover_sheet <- function(file) {
  ## read 2021 arctic lter % cover data sheets 
  site <- readxl::read_xlsx(file, col_names = F, range = "A1:A1")[[1]] %>% 
    str_extract('\\b\\w+$') # extracts after non-word character, using \\b
  block <- readxl::read_xlsx(file, col_names = F, range = "D1")[[1]] %>% 
    str_extract('\\b\\w+$') %>% as.integer()
  treatment <- readxl::read_xlsx(file, col_names = F, range = "G1")[[1]] %>% 
    str_extract('\\b\\w+$') 
  values <- readxl::read_xlsx(file, range = "A4:I30")
  
  # make dataframe 
  data <- values %>% pivot_longer(
    cols = '1':'8',
    names_to = "plot", 
    values_to = "cover"
  ) %>% 
    rename(Species.Code = ...1) %>% 
    mutate(Year = 2021, Site = site, Block = block, Treatment = treatment)
  
  return(data) 
}

## load data for 2021
files <- list.files(path = "data/arc-lter_mat06_2021/",full.names = T)

file <- files[1]

data <- map_dfr(files, read_cover_sheet)
totals <- data %>% group_by(Block, Treatment, plot) %>% summarize(total = sum(cover, na.rm = T))

rel_data <- data %>% left_join(totals) %>% 
  mutate(Relative.cover = cover / total)


```

## MAT06 % load data 
```{r}
# Package ID: knb-lter-arc.20084.2 Cataloging System:https://pasta.edirepository.org.
# Data set title: Relative percent cover of plant species in low nutrient LTER moist acidic tundra experimental plots (MAT06) established in 2006 for years 2008, 2010-2020, Arctic LTER Toolik Field Station Alaska..
# Data set creator:  Laura Gough - Towson University 
# Contact:  Laura Gough -  Towson University  - lgough@towson.edu
# Contact:    - Information Manger ARCTIC LTER  - arc_im@mbl.edu
# Stylesheet for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@Virginia.edu 
#
#install package tidyverse if not already installed
if(!require(tidyverse)){ install.packages("tidyverse") }  
library("tidyverse") 
infile1 <- trimws("https://pasta.lternet.edu/package/data/eml/knb-lter-arc/20084/2/66dcbe2b73b3f5bb606072705e5f1fd7") 
infile1 <-sub("^https","http",infile1)
# This creates a tibble named: dt1 
	dt1 <-read_delim(infile1  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "Year",   
                        "Site",   
                        "Treatment",   
                        "Block",   
                        "Plot",   
                        "Species",   
                        "Rel.cover",   
                        "Accepted.Latin.Name.or.category"   ), 
                    col_types=list(
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() ,  
                        col_character()), 
                        na=c(" ",".","NA")  )
                    
                
# # Observed issues when reading the data. An empty list is good!
# problems(dt1) 
# # Here is the structure of the input data tibble: 
# glimpse(dt1) 
# # And some statistical summaries of the data 
# summary(dt1) 
# # Get more details on character variables
#                      
 summary(as.factor(dt1$Site)) 
 summary(as.factor(dt1$Treatment)) 
 summary(as.factor(dt1$Block)) 
# summary(as.factor(dt1$Plot)) 
# summary(as.factor(dt1$Species)) 
# summary(as.factor(dt1$Accepted.Latin.Name.or.category))

## ERROR CHECKING
# there are three duplicate plot/species entries with different values. I think it's a misnumbering of the plots. How should I edit? 

# dt1 %>%  group_by(Year, Treatment, Block, Plot, Species) %>% summarize(count = n()) %>% 
#   filter(count >1) %>% left_join(dt1) %>% 
#   ungroup() %>% 
#   select(Year, Treatment, Block, Species) %>% 
#   left_join(dt1)
# 
# dt1 %>% group_by(Treatment, Block, Year, Plot, Site) %>% summarize(total_cover = sum(Rel.cover))

# Create a Species List
dt1 %>% select(Species, Accepted.Latin.Name.or.category) %>%
  unique() %>%
  write_csv("mat06_species_list.csv")

# Functional groupings 
species_group <- read_csv("data/mat06_species-to-functional-group.csv") %>% 
  mutate(functional_group = factor(functional_group, levels = c("deciduous", "evergreen", "graminoid", "forb", "moss", "lichen", "litter", "dead", "ground")))

## Community Composition Scan 

# Tidy Data 
tidy_data <- dt1 %>% 
  # column formats 
  mutate(Block = as.numeric(Block), Plot = as.numeric(Plot)) %>% 
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Treatment = factor(Treatment, levels = c("CT", "F2", "F5", "F10"))) %>% 
  mutate(Accepted.Latin.Name.or.category = trimws(Accepted.Latin.Name.or.category)) %>% 
  # remove Block 4
  filter(Block != 4) %>% 
  # create grouped categories 
  left_join(species_group)

## Load total cover 
cover_totals <- read_csv("/home/ruby/Projects/tundra_coexistence/data/mat06_cover_totals_2017-2020.csv") %>% 
  pivot_longer(cols = `1`:`8`,
               names_to = "Plot",
               values_to = "Total.cover",
               values_drop_na = T)  %>% 
  mutate(Plot = as.numeric(Plot))


total_data <- tidy_data %>% left_join(cover_totals) %>% # filter(!is.na(Total.cover)) %>% 
  mutate(Abs.cover = Rel.cover*Total.cover)


### 2021 data
# read in relevant files
data_2021 <- read_csv("data/mat06_cover_2021/percentCover2021.csv")
sp_abbrev <- read_csv("data/mat06_species_abbrev_2021.csv") %>% 
  rename(Species = Species_2021)
species_list <- read_csv("data/mat06_species_list.csv")

# make tidy dataframe
tidy_data_2021 <- data_2021 %>% 
  filter(site == "MAT06") %>% 
  mutate(Year = year(date),
         Site = "06MAT", 
         Treatment = case_when(
           treatment == "C" ~ "CT",
           TRUE ~ treatment
         ),
         Block = block,
         Plot = quadrat,
         ) %>% 
  ## condense sp. codes
  pivot_longer(cols= 6:37, names_to = "Species", values_to = "Cover")  %>% 
  filter(! Species %in% c("# tuss.", "holes", "voles", "% litter")) %>%  # remove tussock counts from cover
    select(-date, -site, -block, -treatment, -quadrat, -`0`) %>% 
  ## standardize sp. codes to 2008-2020 convention
  left_join(sp_abbrev) %>% 
  rename(Abbreviation_2021 = Species) %>% 
  rename(Species = Abbreviation_standard) %>% 
  ## add Accepted Latin name & functional group
  left_join(species_list)

# calculate total cover
total_cover_2021 <- tidy_data_2021 %>% group_by(Year, Site, Treatment, Block, Plot) %>% summarize(Total.cover = sum(Cover, na.rm = T))
         
total_data_2021 <- tidy_data_2021 %>% left_join(total_cover_2021) %>% 
  mutate(Rel.cover = Cover/Total.cover*100) %>% 
  rename(Abs.cover = Cover) %>% 
  select(-Abbreviation_2021) %>% 
  # Select just relevant parts 
  filter(Treatment %in% c("CT", "F2", "F5", "F10")) %>% 
  mutate(Treatment = factor(Treatment, levels = c("CT", "F2", "F5", "F10"))) 



## ALL DATA 2008-2021
all_data <- total_data %>% 
  bind_rows(total_data_2021)

## Save the version I want 
write_csv(all_data, "data/mat06_cover_all.csv")
```

## MAT06 VIZ 

### Snapshot of community composition over time
```{r}
tidy_data <- read_csv("data/mat06_cover_all.csv") %>% 
    mutate(Treatment = factor(Treatment, levels = c("CT", "F2", "F5", "F10"))) 


#### Area plot of sp. means by plot 
# Average data
mean_data <- tidy_data %>% 
  group_by(Year, Treatment, Block, Plot, functional_group) %>% 
  summarize(cover = mean(Rel.cover), max = mean(Rel.cover) + sd(Rel.cover), min = mean(Rel.cover) - sd(Rel.cover))

# VIZ
ggplot(mean_data, aes(x=Year,y=cover, fill = functional_group)) + 
  geom_area() + 
    facet_grid(Block ~ Treatment + Plot) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_minimal() 

#### Functional_group composition by treatment 
  # A different number of 1 x 1 m2 quadrats were surveyed each years.
  # summing relative cover is hard to compare across years. 
  # this code divides the summed cover by the number of quadrats surveyd that year
  # e.g. 5 quads/plot in 2020, 4 quads / plot in 2008, 8 quads / plot in most years
plot_count <- tidy_data %>% select(Year,Block,Treatment, Plot) %>% unique() %>% 
  group_by(Year,Block,Treatment) %>% 
  summarize(count = n())

bar_plot <- tidy_data %>% left_join(plot_count) %>% 
  mutate(plot.cover = Rel.cover/count)

# VIZ
ggplot(bar_plot, aes(x=Year, y=plot.cover, fill = functional_group)) + 
  geom_bar(stat = "identity") + facet_wrap(vars(Treatment)) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_bw() 

```

## Dynamics of Common Species 
```{r}
#### Tracking Species with geom_smooth
my_species <- c("Bet nan", "Sal pul", "Led pal", "Vac vit")

sp_data <- tidy_data %>% 
  filter(Species %in% my_species) 

ggplot() + 
  geom_point(data = sp_data, aes(x=Year, y = Rel.cover, color = Species)) +   geom_smooth(data = sp_data, aes(x=Year, y = Rel.cover, color = Species, fill = Species)) +
    scale_y_continuous(limits = c(0,NA)) +
    scale_x_continuous(breaks = c(seq(2008,2021,1))) + 
   # scale_fill_manual(labels = c("Betula nana", "Graminoid", "Evergreen"), values = c("red3", "dodgerblue3", "green4")) +
    #scale_color_manual(labels = c("Betula nana", "Graminoid", "Evergreen"), values = c("red3",  "dodgerblue3", "green4")) +
    scale_color_manual(values = c("firebrick3", "maroon","dodgerblue3", "blue3", "green4", "limegreen"), labels=c('Betula nana', "Salix pulchra", 'Rhododendron tomentosum', "Vaccinium vitis-idea")) +
      scale_fill_manual(values = c("firebrick3", "maroon","dodgerblue3", "blue3", "green4", "limegreen"), labels=c('Betula nana', "Salix pulchra", 'Rhododendron tomentosum', "Vaccinium vitis-idea")) +
    theme_minimal() + 
    theme(text=element_text(size=18),
          axis.text.x = element_text(angle=90),
          strip.text.x = element_text(size=25)) + 
    labs(y = "Relative % cover") +
    facet_grid(. ~ Treatment) 

```
Each one of the points is a 1x1m2 plot. You can see that Betula nana takes over in the F10 plots and has increased in abundance in the F5. In Block 1 & 2, Ledum palustre is doing as well or better than Betula. It's only in Block 3, where Betula Nana has taken over in F5 treatment already. 


### Relative vs Absolute Cover 
```{r}

#### Tracking Species with geom_smooth -- Total Cover Edition
abs_sp_data <- sp_data %>% 
  left_join(cover_totals) %>% 
  mutate(Treatment = factor(Treatment, levels = c("CT", "F2", "F5", "F10"))) %>%
  mutate(Abs.cover = Rel.cover*Total.cover/100) %>% 
  # compare relative and absolute cover
  pivot_longer(cols = c(Rel.cover,Abs.cover,Total.cover), names_to = "Cover.Type", values_to = "cover") %>% 
  # choose certain species 
  filter(Species %in% my_species) %>% 
  mutate(Block.Plot = str_c(Block, "_", Plot, "_", Cover.Type))

## Cover Totals frmo 2017 - 2020
ggplot(abs_sp_data %>% filter(Cover.Type == "Total.cover") %>% filter(Year > 2016)) + 
  # geom_point(aes(x = Year, y = cover, color = Treatment)) + 
  geom_boxplot(aes(x=factor(Year), y = cover, color = Treatment)) + 
  scale_x_discrete(breaks = c(seq(2017, 2021, 1))) + 
  theme_bw() + 
  labs(y = "Total Cover", x = "Year") 

  

## Change in Species 
ggplot(abs_sp_data) + 
  geom_point( aes(x=Year, y = cover, color = Cover.Type)) + 
  geom_smooth(aes(x=Year, y = cover, color = Cover.Type, fill = Cover.Type)) +
  geom_line(aes(x=Year, y = cover, color = Cover.Type, group = Block.Plot)) + 
  scale_y_continuous(limits = c(0,NA)) +
  scale_x_continuous(breaks = c(seq(2008,2020,1))) + 
  theme_minimal() + 
  theme(text=element_text(size=18),
        axis.text.x = element_text(angle=90),
        strip.text.x = element_text(size=25)) + 
  labs(y = "% cover") +
  facet_grid(Species ~ Treatment)

```



## MAT89 cover data
```{r}
# Package ID: knb-lter-arc.20090.1 Cataloging System:https://pasta.edirepository.org.
# Data set title: Relative percent cover of plant species for years 2012-2017 in the Arctic Long-term Ecological Research (ARC-LTER) 1989 moist acidic tundra (MAT89) experimental plots, Toolik Field Station, Alaska..
# Data set creator:  Laura Gough - Towson University 
# Metadata Provider:    - Arctic Long Term Ecological Research 
# Contact:  Laura Gough -  Towson University  - lgough@towson.edu
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu 

inUrl1  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-arc/20090/1/7bc3b05092c8d000af8c47335b17115c" 
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")

                   
 dt1 <-read.csv(infile1,header=F 
          ,skip=4
            ,sep=","  
                ,quot='"' 
        , col.names=c(
                    "Treatment.Start.Year",     
                    "Treatment.End.Year",     
                    "Year",     
                    "Site",     
                    "Treatment",     
                    "Block",     
                    "Plot",     
                    "Species.Code",     
                    "Relative.Cover",     
                    "Plant.name.or.category",     
                    "Accepted.Latin.Name.or.category"    ), check.names=TRUE)
               
unlink(infile1)
		    
# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings
                
if (class(dt1$Site)!="factor") dt1$Site<- as.factor(dt1$Site)
if (class(dt1$Treatment)!="factor") dt1$Treatment<- as.factor(dt1$Treatment)
if (class(dt1$Block)!="factor") dt1$Block<- as.factor(dt1$Block)
if (class(dt1$Plot)!="factor") dt1$Plot<- as.factor(dt1$Plot)
if (class(dt1$Species.Code)!="factor") dt1$Species.Code<- as.factor(dt1$Species.Code)
if (class(dt1$Relative.Cover)=="factor") dt1$Relative.Cover <-as.numeric(levels(dt1$Relative.Cover))[as.integer(dt1$Relative.Cover) ]               
if (class(dt1$Relative.Cover)=="character") dt1$Relative.Cover <-as.numeric(dt1$Relative.Cover)
if (class(dt1$Plant.name.or.category)!="factor") dt1$Plant.name.or.category<- as.factor(dt1$Plant.name.or.category)
if (class(dt1$Accepted.Latin.Name.or.category)!="factor") dt1$Accepted.Latin.Name.or.category<- as.factor(dt1$Accepted.Latin.Name.or.category)
                
# Convert Missing Values to NA for non-dates

# Here is the structure of the input data frame:
str(dt1)                            
attach(dt1)                            
# The analyses below are basic descriptions of the variables. After testing, they should be replaced.                 

summary(Treatment.Start.Year)
summary(Treatment.End.Year)
summary(Year)
summary(Site)
summary(Treatment)
summary(Block)
summary(Plot)
summary(Species.Code)
summary(Relative.Cover)
summary(Plant.name.or.category)
summary(Accepted.Latin.Name.or.category) 
                # Get more details on character variables
                 
summary(as.factor(dt1$Site)) 
summary(as.factor(dt1$Treatment)) 
summary(as.factor(dt1$Block)) 
summary(as.factor(dt1$Plot)) 
summary(as.factor(dt1$Species.Code)) 
summary(as.factor(dt1$Plant.name.or.category)) 
summary(as.factor(dt1$Accepted.Latin.Name.or.category))
detach(dt1)               
        

subset <- dt1 %>% 
  filter(Treatment %in% c("Control", "Control Unfenced", "Nitrogen Phosphorus Unfenced",  
  "Nitrogen Phosphorus")) %>% 
  mutate(Year = as.numeric(Year)) 
```

## MAT89 viz 
```{r}
## Species Dynamics 
ggplot(data = subset) + 
  geom_point(aes(x=Year, y = Relative.Cover, color = Species.Code)) + 
  geom_smooth(aes(x=Year, y = Relative.Cover, color = Species.Code, fill = Species.Code))  +
  facet_wrap(Block ~ Treatment)

# Community Composition Snapshot
sp_subset <- subset  %>% 
  group_by(Year, Treatment, Species.Code) %>% 
  summarize(cover = mean(Relative.Cover), max = mean(Relative.Cover) + sd(Relative.Cover), min = mean(Relative.Cover) - sd(Relative.Cover)) %>%
 filter(Species.Code %in% c("Bet nan", "litter", "Rub cha", "Eri vag", "Led pal", "St. D. Bet."))

ggplot(sp_subset) + 
  geom_area(aes(x=Year, y = cover, fill = Species.Code)) + 
  scale_fill_brewer(palette = "Set1") + 
  facet_wrap(vars(Treatment))



```

## Scrap
```{r}
## error checking
tidy_data %>% filter(Block == 1, Year == 2013) %>% arrange(Year, Site, Treatment, Block, Plot, Species) %>% print(n=400)

tidy_data %>% filter(Block == 1, Year == 2013) %>% group_by(Year, Site, Block, Plot) %>% summarize(total = sum(Rel.cover))
```

```{r}

# Average data
mean_data <- total_data %>% 
  group_by(Year, Treatment, Block, Plot, functional_group) %>% 
  summarize(cover = mean(Rel.cover), max = mean(Rel.cover) + sd(Rel.cover), min = mean(Rel.cover) - sd(Rel.cover))

## Viz
#### Area plot of sp. means 
  ggplot(mean_data, aes(x=Year,y=cover, fill = functional_group)) + 
  geom_area() + 
    facet_grid(Block ~ Treatment) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_minimal() 

#### functional_group composition by plot

bar_plot <- tidy_data %>% left_join(plot_count) %>% 
  mutate(plot.cover = Rel.cover/count)

ggplot(bar_plot, aes(x=Year, y=plot.cover, fill = Species)) + 
  geom_bar(stat = "identity") + facet_grid(Block ~ Treatment) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_bw() 

# Functional Categories 
cat_bare <- c("Bare soil", "Soil Frost boil")
cat_dead <- c("Standing dead Ledum palustre", "Standing Dead Betula nana", "Standing Dead Salix")
cat_gram <- c("grass", "graminoid")

## ploting averages for species 

avg_data <- sp_data %>% 
    group_by(Year, Treatment, Block, Site, Species, Accepted.Latin.Name.or.category) %>%
    summarize(Rel.cover = mean(Rel.cover)) 


```


Add analyses to this when they output figures that I want to save. 

## OLD CODE

## MAT06 % cover data exploration 
```{r}
# Package ID: knb-lter-arc.20084.2 Cataloging System:https://pasta.edirepository.org.
# Data set title: Relative percent cover of plant species in low nutrient LTER moist acidic tundra experimental plots (MAT06) established in 2006 for years 2008, 2010-2020, Arctic LTER Toolik Field Station Alaska..
# Data set creator:  Laura Gough - Towson University 
# Contact:  Laura Gough -  Towson University  - lgough@towson.edu
# Contact:    - Information Manger ARCTIC LTER  - arc_im@mbl.edu
# Stylesheet for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@Virginia.edu 
#
#install package tidyverse if not already installed
if(!require(tidyverse)){ install.packages("tidyverse") }  
library("tidyverse") 
infile1 <- trimws("https://pasta.lternet.edu/package/data/eml/knb-lter-arc/20084/2/66dcbe2b73b3f5bb606072705e5f1fd7") 
infile1 <-sub("^https","http",infile1)
# This creates a tibble named: dt1 
	dt1 <-read_delim(infile1  
                ,delim=","   
                ,skip=1 
                    ,quote='"'  
                    , col_names=c( 
                        "Year",   
                        "Site",   
                        "Treatment",   
                        "Block",   
                        "Plot",   
                        "Species",   
                        "Rel.cover",   
                        "Accepted.Latin.Name.or.category"   ), 
                    col_types=list(
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(),  
                        col_character(), 
                        col_number() ,  
                        col_character()), 
                        na=c(" ",".","NA")  )
                    
                
# # Observed issues when reading the data. An empty list is good!
# problems(dt1) 
# # Here is the structure of the input data tibble: 
# glimpse(dt1) 
# # And some statistical summaries of the data 
# summary(dt1) 
# # Get more details on character variables
#                      
# summary(as.factor(dt1$Site)) 
# summary(as.factor(dt1$Treatment)) 
# summary(as.factor(dt1$Block)) 
# summary(as.factor(dt1$Plot)) 
# summary(as.factor(dt1$Species)) 
# summary(as.factor(dt1$Accepted.Latin.Name.or.category))
	
## ERROR CHECKING
# there are three duplicate plot/species entries with different values. I think it's a misnumbering of the plots. How do you edit 

dt1 %>%  group_by(Year, Treatment, Block, Plot, Species) %>% summarize(count = n()) %>% 
  filter(count >1) %>% left_join(dt1) %>% 
  ungroup() %>% 
  select(Year, Treatment, Block, Species) %>% 
  left_join(dt1)

dt1 %>% group_by(Treatment, Block, Year, Plot, Site) %>% summarize(total_cover = sum(Rel.cover))

## Create a Species List 
dt1 %>% select(Accepted.Latin.Name.or.category) %>% 
  mutate(functional_group = "") %>% 
  unique() %>% 
  write_csv("mat06_species_list.csv")

# functional groupings 
species_list <- read_csv("data/mat06_species_list.csv") %>% 
  mutate(functional_group = factor(functional_group, levels = c("deciduous", "evergreen", "graminoid", "forb", "moss", "lichen", "litter", "dead", "ground")))

## Community composition Scan 

# Tidy Data 
tidy_data <- dt1 %>% 
  # column formats 
  mutate(Year = as.numeric(Year)) %>% 
  mutate(Treatment = factor(Treatment, levels = c("CT", "F2", "F5", "F10"))) %>% 
  mutate(Accepted.Latin.Name.or.category = trimws(Accepted.Latin.Name.or.category)) %>% 
  # remove Block 4
  filter(Block != 4) %>% 
  # create grouped categories 
  left_join(species_list)

# Average data
mean_data <- tidy_data %>% 
  group_by(Year, Treatment, Block, Plot, functional_group) %>% 
  summarize(cover = mean(Rel.cover), max = mean(Rel.cover) + sd(Rel.cover), min = mean(Rel.cover) - sd(Rel.cover))
```

# MAT06 VIZ 

## Snapshot of community composition over time
```{r}

## Viz
#### Area plot of sp. means 
  ggplot(mean_data, aes(x=Year,y=Rel.cover, fill = functional_group)) + 
  geom_area() + 
    facet_grid(Block ~ Treatment) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_minimal() 

#### functional_group composition by plot

bar_plot <- tidy_data %>% left_join(plot_count) %>% 
  mutate(plot.cover = Rel.cover/count)

ggplot(bar_plot, aes(x=Year, y=plot.cover, fill = functional_group)) + 
  geom_bar(stat = "identity") + facet_grid(Block ~ Treatment) + 
    scale_fill_brewer(palette = "Set1") + 
    theme_bw() 
```

```{r}
## error checking
tidy_data %>% filter(Block == 1, Year == 2013) %>% arrange(Year, Site, Treatment, Block, Plot, Species) %>% print(n=400)

tidy_data %>% filter(Block == 1, Year == 2013) %>% group_by(Year, Site, Block, Plot) %>% summarize(total = sum(Rel.cover))
```

## Dynamics of Common Species 
```{r}
#### Tracking Species with geom_smooth
my_species <- c("Bet nan", "Eri vag", "Led pal", "Vac vit", "litter", "moss")

sp_data <- tidy_data %>% 
  filter(Species %in% my_species) 

ggplot() + 
geom_point(data = sp_data, aes(x=Year, y = Rel.cover, color = Species)) +   geom_smooth(data = sp_data, aes(x=Year, y = Rel.cover, color = Species, fill = Species)) +
  scale_y_continuous(limits = c(0,NA)) +
  scale_x_continuous(breaks = c(seq(2008,2020,1))) + 
  scale_fill_brewer(palette = "Set1") +
  scale_color_brewer(palette = "Set1") +
  theme_minimal() + 
  facet_grid(Block ~ Treatment) 

```
Each one of the points is a 1x1m2 plot. You can see that Betula nana takes over in the F10 plots and has increased in abundance in the F5. In Block 1 & 2, Ledum palustre is doing as well or better than Betula. It's only in Block 3, where Betula Nana has taken over in F5 treatment already. 

## MAT89 cover data
```{r}
# Package ID: knb-lter-arc.20090.1 Cataloging System:https://pasta.edirepository.org.
# Data set title: Relative percent cover of plant species for years 2012-2017 in the Arctic Long-term Ecological Research (ARC-LTER) 1989 moist acidic tundra (MAT89) experimental plots, Toolik Field Station, Alaska..
# Data set creator:  Laura Gough - Towson University 
# Metadata Provider:    - Arctic Long Term Ecological Research 
# Contact:  Laura Gough -  Towson University  - lgough@towson.edu
# Stylesheet v2.11 for metadata conversion into program: John H. Porter, Univ. Virginia, jporter@virginia.edu 

inUrl1  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-arc/20090/1/7bc3b05092c8d000af8c47335b17115c" 
infile1 <- tempfile()
try(download.file(inUrl1,infile1,method="curl"))
if (is.na(file.size(infile1))) download.file(inUrl1,infile1,method="auto")

                   
 dt1 <-read.csv(infile1,header=F 
          ,skip=4
            ,sep=","  
                ,quot='"' 
        , col.names=c(
                    "Treatment.Start.Year",     
                    "Treatment.End.Year",     
                    "Year",     
                    "Site",     
                    "Treatment",     
                    "Block",     
                    "Plot",     
                    "Species.Code",     
                    "Relative.Cover",     
                    "Plant.name.or.category",     
                    "Accepted.Latin.Name.or.category"    ), check.names=TRUE)
               
unlink(infile1)
		    
# Fix any interval or ratio columns mistakenly read in as nominal and nominal columns read as numeric or dates read as strings
                
if (class(dt1$Site)!="factor") dt1$Site<- as.factor(dt1$Site)
if (class(dt1$Treatment)!="factor") dt1$Treatment<- as.factor(dt1$Treatment)
if (class(dt1$Block)!="factor") dt1$Block<- as.factor(dt1$Block)
if (class(dt1$Plot)!="factor") dt1$Plot<- as.factor(dt1$Plot)
if (class(dt1$Species.Code)!="factor") dt1$Species.Code<- as.factor(dt1$Species.Code)
if (class(dt1$Relative.Cover)=="factor") dt1$Relative.Cover <-as.numeric(levels(dt1$Relative.Cover))[as.integer(dt1$Relative.Cover) ]               
if (class(dt1$Relative.Cover)=="character") dt1$Relative.Cover <-as.numeric(dt1$Relative.Cover)
if (class(dt1$Plant.name.or.category)!="factor") dt1$Plant.name.or.category<- as.factor(dt1$Plant.name.or.category)
if (class(dt1$Accepted.Latin.Name.or.category)!="factor") dt1$Accepted.Latin.Name.or.category<- as.factor(dt1$Accepted.Latin.Name.or.category)
                
# Convert Missing Values to NA for non-dates

# Here is the structure of the input data frame:
str(dt1)                            
attach(dt1)                            
# The analyses below are basic descriptions of the variables. After testing, they should be replaced.                 

summary(Treatment.Start.Year)
summary(Treatment.End.Year)
summary(Year)
summary(Site)
summary(Treatment)
summary(Block)
summary(Plot)
summary(Species.Code)
summary(Relative.Cover)
summary(Plant.name.or.category)
summary(Accepted.Latin.Name.or.category) 
                # Get more details on character variables
                 
summary(as.factor(dt1$Site)) 
summary(as.factor(dt1$Treatment)) 
summary(as.factor(dt1$Block)) 
summary(as.factor(dt1$Plot)) 
summary(as.factor(dt1$Species.Code)) 
summary(as.factor(dt1$Plant.name.or.category)) 
summary(as.factor(dt1$Accepted.Latin.Name.or.category))
detach(dt1)               
        

subset <- dt1 %>% 
  filter(Treatment %in% c("Control", "Control Unfenced", "Nitrogen Phosphorus Unfenced",  
  "Nitrogen Phosphorus")) %>% 
  mutate(Year = as.numeric(Year)) 
```

## MAT89 viz 
```{r}
## Species Dynamics 
ggplot(data = subset) + 
  geom_point(aes(x=Year, y = Relative.Cover, color = Species.Code)) + 
  geom_smooth(aes(x=Year, y = Relative.Cover, color = Species.Code, fill = Species.Code))  +
  facet_wrap(Block ~ Treatment)

# Community Composition Snapshot
sp_subset <- subset  %>% 
  group_by(Year, Treatment, Species.Code) %>% 
  summarize(cover = mean(Relative.Cover), max = mean(Relative.Cover) + sd(Relative.Cover), min = mean(Relative.Cover) - sd(Relative.Cover)) %>%
 filter(Species.Code %in% c("Bet nan", "litter", "Rub cha", "Eri vag", "Led pal", "St. D. Bet."))

ggplot(sp_subset) + 
  geom_area(aes(x=Year, y = cover, fill = Species.Code)) + 
  scale_fill_brewer(palette = "Set1") + 
  facet_wrap(vars(Treatment))



```

